<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>App Visita Externa Vers√£o 1.0.0-beta</title>
    <script type="module" src="js/lib/dexie.mjs"></script>
    <script type="module" src="js/database.js"></script>
    <script type="module" src="js/tela_cadastro.js"></script>
    <script type="module" src="js/main.js"></script>
    <script type="module" src="js/state.js"></script>
    <link rel="stylesheet" href="estilos/style_tela_cadastro.css" />
    <link rel="manifest" href="manifest.json" />
    <!--<link rel="manifest" href="https://mpgabler.github.io/App-Visita-Externa/manifest.json">-->
    <link rel="icon" type="image/png" sizes="192x192" href="assets/icon.png" />
    <link
      rel="icon"
      type="image/png"
      sizes="512x512"
      href="assets/icon-512.png"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="32x32"
      href="assets/favicon-32x32.png"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="16x16"
      href="assets/favicon-16x16.png"
    />
    <link
      rel="icon"
      type="image/x-icon"
      sizes="48x48"
      href="assets/favicon.ico"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="512x512"
      href="assets/logo-ceasa.png"
    />
  </head>

  <body>
    <!-- Cabe√ßalho de impress√£o da p√°gina de cadastro -->
    <div class="print-header">
      <img src="./assets/logo-ceasa.png" alt="Logo" />
      <div class="header-info">
        <p>Data: <span id="data-emissao"></span></p>
        <p>T√©cnico: Ronan Campos</p>
      </div>
    </div>

    <main class="">
      <form id="formulario" class="form-container">
        <h3>Relat√≥rio T√©cnico</h3>

        <!-- Identifica√ß√£o -->
        <fieldset>
          <legend>Identifica√ß√£o da Propriedade</legend>
          <label>Propriedade:</label>
          <input type="text" name="propriedade" id="propriedade" />

          <label>Produtor Rural:</label>
          <input type="text" name="produtor" id="produtor" />

          <label>Local (Munic√≠pio):</label>
          <input type="text" name="local" id="municipio" />

          <label>Telefone Principal:</label>
          <input
            type="tel"
            name="telefone"
            id="telefone_principal"
            placeholder="27 99999-9999"
            pattern="^\(\d{2}\)\s(9\s)?\d{4}-\d{4}$"
            title="Digite apenas n√∫meros (ex: 27999999999 para 10/11 d√≠gitos). Formato: DDD + n√∫mero."
            maxlength="16"
          />

          <label>Telefone Contato (opcional):</label>
          <input
            type="tel"
            name="telefone_contato"
            placeholder="27 99999-9999"
            pattern="^\(\d{2}\)\s(9\s)?\d{4}-\d{4}$"
            title="Digite apenas n√∫meros (ex: 27999999999 para 10/11 d√≠gitos). Formato: DDD + n√∫mero."
            id="telefone_contato"
            maxlength="16"
          />

          <label>Inscri√ß√£o Estadual (opcional):</label>
          <input
            type="text"
            name="inscricao_estadual"
            id="inscricao_estadual"
          />
        </fieldset>

        <!-- √Årea -->
        <fieldset>
          <legend>Caracter√≠sticas da √Årea</legend>
          <label>√Årea Total (ha):</label>
          <input type="number" step="0.01" name="area_total" id="area_total" />

          <label>√Årea Produtiva (ha):</label>
          <input
            type="number"
            step="0.01"
            name="area_produtiva"
            id="area_produtiva"
          />

          <div class="apresentacao__itens__radio">
            <label>Possui Reserva Legal?</label>
            <label
              ><input
                type="radio"
                name="reserva"
                value="sim"
                id="reserva_legal_sim"
              />
              Sim</label
            >
            <label
              ><input
                type="radio"
                name="reserva"
                value="nao"
                id="reserva_legal_nao"
              />
              N√£o</label
            >
          </div>

          <div class="apresentacao__itens__radio">
            <label>Cadastro Ambiental Rural (CAR):</label>
            <label
              ><input type="radio" name="car" value="sim" id="car_sim" />
              Sim</label
            >
            <label
              ><input type="radio" name="car" value="nao" id="car_nao" />
              N√£o</label
            >
          </div>
        </fieldset>

        <!-- Comerciais -->
        <fieldset>
          <legend>Aspectos Comerciais</legend>

          <div class="apresentacao__itens__radio">
            <label>Emite Nota Fiscal?</label>
            <label
              ><input
                type="radio"
                name="nota_fiscal"
                value="sim"
                id="nota_fiscal_sim"
              />
              Sim</label
            >
            <label
              ><input
                type="radio"
                name="nota_fiscal"
                value="nao"
                id="nota_fiscal_nao"
              />
              N√£o</label
            >
          </div>

          <div class="apresentacao__itens__radio">
            <label>Utiliza Etiqueta de Rastreabilidade?</label>
            <label
              ><input
                type="radio"
                name="rastreabilidade"
                value="sim"
                id="etiqueta_sim"
              />Sim</label
            >
            <label
              ><input
                type="radio"
                name="rastreabilidade"
                value="nao"
                id="etiqueta_nao"
              />N√£o</label
            >
          </div>

          <div class="apresentacao__itens__radio">
            <label>Afiliado a Cooperativa?</label>
            <label
              ><input
                type="radio"
                id="sim_afiliado"
                name="cooperativa"
                value="sim"
              />
              Sim</label
            >
            <label
              ><input
                type="radio"
                id="nao_afiliado"
                name="cooperativa"
                value="nao"
              />
              N√£o</label
            >
          </div>
          <input
            type="text"
            class="textarea_afiliado"
            id="textarea_afiliado"
            name="qual_coop"
            placeholder="Qual?"
            style="display: none"
          />
        </fieldset>

        <!-- Produ√ß√£o -->
        <fieldset>
          <legend>Produ√ß√£o e Manejo</legend>

          <div class="suggestions" id="suggestionsProducao"></div>
          <div class="tag-container" id="tagContainerCulturas">
            <label>Principais Produtos:</label>
            <input
              type="text"
              id="inputProducao"
              placeholder="Digite e selecione..."
            />
          </div>

          <div class="suggestions" id="suggestionsIrrigacao"></div>
          <div class="tag-container" id="tagContainerIrrigacao">
            <label>Irriga√ß√£o (tipo):</label>
            <input
              type="text"
              id="inputIrrigacao"
              name="irrigacao"
              placeholder="Digite e selecione..."
            />
          </div>

          <div class="suggestions" id="suggestionsDefensivo"></div>
          <div class="tag-container" id="tagContainerDefensivo">
            <label>Defensivos Agr√≠colas:</label>
            <input
              type="text"
              id="inputDefensivo"
              name="defensivo"
              placeholder="Digite e selecione..."
            />
          </div>

          <div class="suggestions" id="suggestionsMaquinario"></div>
          <div class="tag-container" id="tagContainerMaquinario">
            <label>Maquin√°rio Agr√≠cola:</label>
            <input
              type="text"
              id="inputMaquinario"
              name="maquinario"
              placeholder="Digite e selecione..."
            />
          </div>

          <div class="suggestions" id="suggestionsBeneficiamento"></div>
          <div class="tag-container" id="tagContainerBeneficiamento">
            <label>Beneficiamento (ex.: geleia, polpa, farinha):</label>
            <input
              type="text"
              id="inputBeneficiamento"
              name="beneficiamento"
              placeholder="Digite e selecione..."
            />
          </div>
        </fieldset>

        <!-- Pol√≠ticas P√∫blicas -->
        <fieldset>
          <legend>Pol√≠ticas P√∫blicas</legend>
          <div class="apresentacao__itens__checkbox">
            <label
              ><input
                type="checkbox"
                name="pnae"
                value="sim"
                id="politica_pnae"
              />
              PNAE (Merenda Escolar)</label
            >
            <label
              ><input
                type="checkbox"
                name="paa"
                value="sim"
                id="politica_paa"
              />
              PAA (Aquisi√ß√£o de Alimentos)</label
            >
            <label
              ><input
                type="checkbox"
                id="outras_politicas"
                name="outras_politicas"
                value="sim"
              />
              Outras Pol√≠ticas P√∫blicas</label
            >
            <input
              type="text"
              class="textarea_politicas"
              id="textarea_politicas"
              name="qual_politica"
              placeholder="Qual?"
              style="display: none"
            />
          </div>
        </fieldset>

        <!-- Observa√ß√µes -->
        <fieldset>
          <legend>Observa√ß√µes Gerais</legend>
          <textarea
            id="textAreaObservacoes"
            name="obs"
            rows="4"
            cols="48"
          ></textarea>
        </fieldset>

        <button type="submit" class="botao_salvar">Salvar</button>

        <!-- üîî Alerta customizado -->
        <div id="alerta" class="alerta">Cadastro Realizado com Sucesso!</div>
      </form>

      <button
        id="btnAlternar"
        type="button"
        style="
          display: none;
          background: #2f855a;
          color: white;
          border: none;
          padding: 15px;
          border-radius: 4px;
        "
      >
        Editar
      </button>
    </main>

    <footer class="rodape">
      <p>&copy; 2025 App Visitas Externas - Ceasa Esp√≠rito Santo</p>
    </footer>

    <div id="modalErro" class="modal" style="display: none">
      <div class="modal-conteudo">
        <span class="fechar">&times;</span>
        <!-- <h3>Erro na Valida√ß√£o</h3> -->
        <p id="mensagemModal">
          Por favor, preencha os campos obrigat√≥rios sinalizados em laranja.
        </p>
        <button id="btnFecharModal">OK</button>
      </div>
    </div>

    <script type="module">
      import db from "./js/database.js";

      // --- CONFIGURA√á√ÉO E FUN√á√ïES API ---

      const API_URL =
        "https://app.nocodb.com/api/v2/tables/mmh644yili3hqlx/records";
      const API_KEY = "9RpEPRafKIOSny73_Bz8rvbDKtmjeBQcz8V_2z-l";

      async function enviarParaNocoDB(dados) {
        const resposta = await fetch(API_URL, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${API_KEY}`,
          },
          body: JSON.stringify(dados),
        });

        if (!resposta.ok) {
          throw new Error(`Erro NocoDB: ${resposta.status}`);
        }

        return await resposta.json();
      }

      // --- L√ìGICA DE SINCRONIZA√á√ÉO (SYNC) ---

      let syncAgendado = false;

      const agendarSync = () => {
        if (syncAgendado) return;
        syncAgendado = true;

        // Agenda a sincroniza√ß√£o para daqui a 1.5s (debounce)
        setTimeout(async () => {
          syncAgendado = false;
          await syncAgora();
        }, 1500);
      };

      const syncAgora = async () => {
        if (!navigator.onLine) return;

        // Busca os registros n√£o sincronizados (sincronizado !== 1)
        const naoSync = await db.cadastro
          .filter((c) => c.sincronizado !== 1)
          .toArray();

        if (naoSync.length === 0) return;

        let contador = 0;

        for (const c of naoSync) {
          // Tenta enviar o registro ao NocoDB (Protege contra erros de rede/API)
          try {
            const dados = {
              ...c,
              sincronizadoEm: new Date().toISOString(),
              ultima_alteracao: new Date().toISOString(),
            };

            // EXCLUI CHAVES INTERNAS
            delete dados.id;
            delete dados.sincronizado;
            delete dados.idRemote;

            // 1. POST NO NOCODB
            const resposta = await enviarParaNocoDB(dados);

            // 2. ATUALIZA√á√ÉO LOCAL (Protege contra falhas no Dexie)
            try {
              await db.cadastro.update(c.id, {
                sincronizado: 1,
                idRemote: resposta.id || resposta.row_id,
              });
              contador++;
            } catch (dbError) {
              console.error(
                `‚ùå FALHA NO UPDATE LOCAL do registro ID ${c.id}. Duplica√ß√£o pode ocorrer!`,
                dbError
              );
            }
          } catch (apiError) {
            console.warn("Falha ao enviar um cadastro ao NocoDB", apiError);
          }
        }

        // Exibe Toast de Sucesso
        if (contador > 0) {
          const toast = document.createElement("div");
          toast.textContent = `${contador} cadastro(s) enviados com sucesso!`;
          toast.style.cssText =
            "position:fixed;bottom:20px;left:50%;transform:translateX(-50%);background:#0f8;color:#000;padding:16px 32px;border-radius:12px;font-weight:bold;z-index:9999;box-shadow:0 4px 12px 30px rgba(0,0,0,0.4);";
          document.body.appendChild(toast);
          setTimeout(() => toast.remove(), 5000);
        }
      };

      // --- GATILHOS ---

      window.addEventListener("load", async () => {
        try {
          // 1. CORRE√á√ÉO DA CONDI√á√ÉO DE CORRIDA: Agenda o sync inicial com delay (1.5s)
          agendarSync();

          // 2. Quando a internet voltar
          window.addEventListener("online", () => {
            console.log("Internet voltou ‚Üí sincronizando...");
            syncAgora();
          });

          // 3. Hooks do Dexie
          db.cadastro.hook("creating", agendarSync);
          db.cadastro.hook("updating", agendarSync);

          console.log("Sincroniza√ß√£o autom√°tica NocoDB ativada!");
        } catch (err) {
          console.error("Erro cr√≠tico no sync:", err);
        }
      });
    </script>

    <!-- Vinculando ao Firebase
    <script type="module">
      import db from "./js/database.js";

      window.addEventListener("load", async () => {
        try {
          // Firebase carregado dinamicamente
          const { initializeApp } = await import(
            "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js"
          );
          const {
            getFirestore,
            collection,
            addDoc,
            enableIndexedDbPersistence,
          } = await import(
            "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js"
          );
          const { getAuth, signInAnonymously } = await import(
            "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js"
          );

          const app = initializeApp({
            apiKey: "AIzaSyDOUIc3_1VujnV40HRU3HYEw6lt4aaZu1w",
            authDomain: "app-visita-externa.firebaseapp.com",
            projectId: "app-visita-externa",
            storageBucket: "app-visita-externa.firebasestorage.app",
            messagingSenderId: "120780076208",
            appId: "1:120780076208:web:5043211212f17bee343775",
          });

          const fs = getFirestore(app);
          const auth = getAuth(app);

          // Persist√™ncia offline do Firestore
          enableIndexedDbPersistence(fs).catch(() => {});

          // Login an√¥nimo seguro
          if (!auth.currentUser) {
            try {
              await signInAnonymously(auth);
            } catch (e) {
              console.error("Erro no login an√¥nimo:", e);
              return;
            }
          }

          console.log("UID logado:", auth.currentUser?.uid);

          //-------------------------------------------------------
          // SYNC INTELIGENTE (CORRIGIDO)
          //-------------------------------------------------------

          let syncAgendado = false;

          const agendarSync = () => {
            if (syncAgendado) return;
            syncAgendado = true;

            setTimeout(async () => {
              syncAgendado = false;
              await syncAgora();
            }, 1500);
          };

          const syncAgora = async () => {
            if (!navigator.onLine) return;

            // CORRE√á√ÉO: busca registros sem sincronizado OU sincronizado != 1
            const naoSync = await db.cadastro
              .filter((c) => c.sincronizado !== 1)
              .toArray();

            if (naoSync.length === 0) return;

            const col = collection(fs, "cadastros");
            let contador = 0;

            for (const c of naoSync) {
              try {
                const dados = {
                  ...c,
                  tecnicoId: auth.currentUser?.uid ?? "desconhecido",
                  sincronizadoEm: new Date().toISOString(),
                  ultima_alteracao: new Date().toISOString(),
                };

                const ref = await addDoc(col, dados);
                await db.cadastro.update(c.id, {
                  sincronizado: 1,
                  idRemote: ref.id,
                });

                contador++;
              } catch (e) {
                console.warn("Falha ao enviar um cadastro", e);
              }
            }

            if (contador > 0) {
              const toast = document.createElement("div");
              toast.textContent = `${contador} cadastro(s) enviados com sucesso!`;
              toast.style.cssText =
                "position:fixed;bottom:20px;left:50%;transform:translateX(-50%);background:#0f8;color:#000;padding:16px 32px;border-radius:12px;font-weight:bold;z-index:9999;box-shadow:0 4px 12px 30px rgba(0,0,0,0.4);";
              document.body.appendChild(toast);
              setTimeout(() => toast.remove(), 5000);
            }
          };

          //-------------------------------------------------------
          // GATILHOS
          //-------------------------------------------------------

          // 1. Tenta sincronizar imediatamente
          syncAgora();

          // 2. Sempre que voltar online
          window.addEventListener("online", () => {
            console.log("Internet voltou ‚Üí sincronizando...");
            syncAgora();
          });

          // 3. Hooks REALMENTE funcionais do Dexie
          db.cadastro.hook("creating", agendarSync);
          db.cadastro.hook("updating", agendarSync);

          console.log("Sincroniza√ß√£o autom√°tica ativada!");
        } catch (err) {
          console.error("Erro cr√≠tico no sync:", err);
        }
      });
    </script> -->
  </body>
</html>
